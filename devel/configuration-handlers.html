<!-- $Id$ -->
<!-- $Source$ -->

<html>
<head>
<title>ProFTPD Developer's Guide: Writing Configuration Handlers</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<img src="../images/proftpd.png">
<br><br>
<h3><b>ProFTPD Developer's Guide: Writing Configuration Handlers</b></h3>
<i><b>ProFTPD Version 1.2</b></i><br>
</center>
<hr><br>

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<p>
<b>Configuration directive handlers</b><br>
Modules can be used to extend the functionality of the server; often that
additional functionality is configurable, and can behave differently according
to the server administrator's needs.  In order to allow the administrator
the ability to tweak the module functionality behavior, the module often
needs to add its own configuration directives.  Thus, one of the common
tasks of the module developer is the writing of a function that handles
a configuration directive, checking it for format, syntax, and sanity.

<p>
The steps taken during the handling of a configuration directive are
straightforward:
<ol>
  <li>check the number of parameters used in the configuration file
  <li>check the configuration contexts in which the directive appeared
  <li>parse the given parameters
  <li>set a configuration record
  <li>documenting the proper usage of the directive
</ol>

<p>
To help facilitate checking the number of parameters given for the
configuration directive there is the
<a href="../api/macros.html#CHECK_ARGS"><code>CHECK_ARGS</code></a> macro.
This macro takes the <code>cmd_rec *</code> passed to the configuration
directive handler function, and the number of arguments that directive
<i>should</i> have.  Note, however, that the current macro is inadequate, as
it only checks that there are <i>at least</i> the requested number of
arguments but does not produce an error if there are <i>more</i> than the
requested number of arguments used.  Other, less frequently used macros
for the checking of number of parameters are
<a href="../api/macros.html#CHECK_HASARGS"><code>CHECK_HASARGS</code></a>
and
<a href="../api/macros.html#CHEKC_VARARGS"><code>CHECK_VARARGS</code></a>.
Thus, for example, to check that your directive is used with at least
two parameters:
<pre>
  CHECK_ARGS(cmd, 2);
</pre>

<p>
As with checking the number of parameters, there is a convenience macro
used to check the context in which your directive was used against a list
of legal contexts:
<a href="../api/macros.html#CHECK_CONF"><code>CHECK_CONF</code></a>.  This
macro takes two arguments: the <code>cmd_rec *</code> passed to the
configuration directive handler, and an <code>OR</code>'d list of context
values (see the Internals page on
<a href="../internals/contexts.html">contexts</a>).  For example, if your
directive should only be used in the <code>&lt;VirtualHost&gt;</code> and
<code>&lt;Directory&gt;</code> contexts:
<pre>
  CHECK_CONF(cmd, CONF_VIRTUAL|CONF_DIR);
</pre>

<p>
Now we come to the substance of the configuration handler: parsing the
parameters given for proper format, syntax, range, and suitability.  What is
proper format, syntax, range, and suitability all depend on the purpose of
your directive, what kind of parameters it should be accepting, and how those
parameters will be used later by the module code.

<p>
First, there's the matter of accessing the parameters that appeared in the
configuration file.  A configuration directive handler accepts a single
argument, a <code>cmd_rec *</code>.  The parameter values for the directive
are stored in this structure in a manner similar to what is passed by the
operating system to any C program's <code>main()</code> function: an
<code>int argc</code> denoting the number of arguments, and an
<code>char **argv</code> containing the array of parameters as strings.  In
the given <code>cmd_rec *</code>, then, <code>cmd-&gt;argc</code> is the number
of parameters used <b>including</b> the directive name itself, and
<code>cmd-&gt;argv</code> are those parameters, also including the directive
name itself (<code>cmd-&gt;argv[0]</code>).
<code>cmd-&gt;argv[cmd-&gt;argc]</code> is always <code>NULL</code>.

<p>
One common type of configuration directive is a simple one, an on/off Boolean
switch.  For parsing a parameter that should be a Boolean value there is the
<a href="../api/functions.html#get_boolean"><code>get_boolean()</code></a>
function.  Many places in the server's core configuration directives will
have:
<pre>
  int bool = -1;
    ...
  if ((bool = get_boolean(cmd, 1)) == -1)
    CONF_ERROR(cmd, "expected boolean value");
</pre>
If the parameter should be a numeric value, make sure that given parameter is
indeed a number (use <code>strtol()</code> or <code>strtoul()</code> for their
range-checking abilities as well as string-to-number conversion ability), and
that the number is within the proper range: is it negative or zero when it
should only be positive?  Is it smaller than the largest possible value in
the parameter range?  If the parameter value should be a path, check that
the given string is an absolute path, if required, and/or that the path
exists, and leads to a file of the correct type (<i>eg</i> directory,
regular file, symbolic link, whatever).  Try to verify and validate as
much as possible at this stage, for it will save you time, debugging, and
error-handling code elsewhere in the module code.

<p>
Once you have parsed and verified the parameters given, it is time to store
them so the the module code elsewhere, later, can retrieve them.  This
<a href="parameter-storage.html">document</a> covers the storage/retrieval
functions in greater detail; it is recommended reading.  One last thing to check
before storing your parameter values is whether your directive should only be
used once, or whether it can appear multiple times in the same context.  If
it is meant only to be set once, you should attempt to retrieve the parameters
before storing them:  if your retrieval succeeds, it means your directive has
already been processed, and the current instance is a syntax error.

<p>
The last duty of the module developer, and the most important duty (from a
user's point of view), is to document what has been developed.  The existing
configuration directive documentation should suffice as a template.  Please
do everyone a favor and distribute documentation with your module, so that
it can be used without requiring users to browse the source code.

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<hr><br>

Author: <i>$Author$</i><br>
Last Updated: <i>$Date$</i><br>

<br><hr>

<font size=2><b><i>
&copy; Copyright 2000,2001 TJ Saunders<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>
