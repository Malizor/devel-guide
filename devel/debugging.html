<!-- $Id$ -->
<!-- $Source$ -->

<html>
<head>
<title>ProFTPD Developer's Guide: Debugging the Code</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<img src="../images/proftpd.png" border=0>
<br><br>
<h3><b>ProFTPD Developer's Guide: Debugging the Code</b></h3>
<i><b>ProFTPD Version 1.2</b></i><br>
</center>
<hr><br>

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<p>
When developing a new module, server debugging can help pinpoint what is
happening in some cases; however, when tracking down such things as
segfaults (&quot;signal 11&quot;) or tracing the logic through a complex
sequence of function calls, more complicated forms of debugging are needed.

<p><b>The Developer <code>configure</code> Option</b><br>
By default, <code>proftpd</code> compiles into an executable suitable for
running on a live server.  However, this means that the executable isn't as
well suited for debugging (debug versions of programs often run slower).
To generate a debug version of <code>proftpd</code>, use the
<code>--enable-devel</code> configure option.  By itself, this option has
two side effects: first, it enables quite a few <code>-W</code> compiler
switches, which make the compiler more verbose and more picky about shadowed
variables, prototype mismatches, use of <code>long double</code>, etc; second,
the generated <code>proftpd</code> binary will not be stripped of its symbols
when <code>make install</code> is run.  This means the binary will be larger,
but it will also be easier to use debugging tools on the binary.  <i>Please</i>
compile your module using <code>--enable-devel</code>, and fixing any generated
errors and warnings, before contributing it.

<p>
The <code>--enable-devel</code> option can also take parameters that alter
<code>proftpd</code>'s behavior.  These parameters are: <code>coredump</code>,
<code>nodaemon</code>, and <code>nofork</code>.  The first parameter,
<code>coredump</code>, enables <code>proftpd</code> to generate a
<code>core</code> file under certain conditions (segfault,
<code>SIGABRT</code>); unless this parameter is used, the code takes stringent
steps explicitly in order to <b>not</b> generate coredumps, by design.
The second parameter, <code>nodaemon</code>, makes <code>proftpd</code> not
use any of the functions it would normally use when daemonizing.  Finally,
the <code>nofork</code> parameter means that <code>proftpd</code> will not
<code>fork()</code> a process to handle a connecting client--all sessions will
be handled by the same <code>proftpd</code> process.  These parameters
can be combined when using the <code>--enable-devel</code> option, like so:
<pre>
  ./configure --enable-devel=nodaemon:nofork ...
</pre>
or, to use them all:
<pre>
  ./configure --enable-devel=coredump:nodaemon:nofork ...
</pre>

<p><b>Tracing Programs</b><br>
Your operating system should provide some utilities to help with system
call tracing (<i>e.g.</i> <code>strace</code> and <code>ltrace</code> on
Linux, <code>ktrace</code> and <code>kdump</code> on FreeBSD, <code>truss</code>
on Solaris, <code>tusc</code> on HP-UX); read their respective man pages for
more information.

<p><b>The GNU Debugger</b><br>
The GNU debugger, <code>gdb</code>, is a superb tool for debugging programs.
Like many such excellent tools, it can be intimidating for the uninitiated,
but its use is <i>highly</i> recommended.  There are even graphical frontends,
such as <a href="http://www.gnu.org/software/ddd/"><code>ddd</code></a> for
those who prefer graphical environments.

<p>
<code>gdb</code> provides the most information when it is used to run a program
that has been linked with the debug version of <code>libc</code>, and whose
symbols have not been stripped.  Thus, configure <code>proftpd</code> using
the <code>--enable-devel</code> configure option.  Then, run your compiled
<code>proftpd</code> binary like so:
<pre>
  # gdb ./proftpd
  Copyright 2001 Free Software Foundation, Inc.
  GDB is free software, covered by the GNU General Public License, and you are
  welcome to change it and/or distribute copies of it under certain conditions.
  Type "show copying" to see the conditions.
  There is absolutely no warranty for GDB.  Type "show warranty" for details.
  (no debugging symbols found)...
  (gdb) 
</pre>
At the prompt, start running the program, and pass it any of the usual
<code>proftpd</code> command-line options:
<pre>
  (gdb) run -nd5
</pre>
You can set breakpoints before running the program, step through certain
functions, etc.  One of the more useful uses of <code>gdb</code> is for
determining where, and how, segfaults occur.  You run <code>proftpd</code>
under the debugger until you trigger the segfault.  <code>gdb</code> will
display a message about catching the <code>SIGSEGV</code> signal, and the
name of the function, file, and line number at which it happened.  Sometimes
this segfault occurs within the C library, but is almost always due to the
application code.  When this happens, at the <code>(gdb)</code> prompt,
generate a <i>backtrace</i>:
<pre>
  (gdb) backtrace
</pre>
A backtrace is a listing of the function call stack, from the start of the
program to the point where the segfault occurs.  One can then quickly
narrow down where in the application code the bug is lurking.

<p><b>Memory</b><br>
C programs are notorious for memory leaks and other memory allocation related
issues.  Numerous articles and programs have been written to address this.
I recommend using <a href="http://developer.kde.org/~sewardj/"><code>valgrind</code></a> or GNU <a href="http://www.gnu.org/software/checker/checker.html"><code>checker</code></a>.

<p>
<b>Profiling</b><br>
Profiling the code can be considered a form of debugging, once all other
functionality-related bugs have been fixed.  In order to compile a profile
version of <code>proftpd</code>, you need the following:
<pre>
  CFLAGS=&quot;-DPR_DEVEL_NO_DAEMON -DPR_DEVEL_NO_FORK -g -pg -a&quot; LIBS=-pg ./configure --enable-devel ...
</pre>
The resulting daemon will only handle one session, as is necessary (the
daemonizing and <code>fork()</code> code interferes with the functioning of the
profiling code added by the compiler).  This profile version will generate
two files, <code>bb.out</code> and <code>gmon.out</code>, in the
<code>RUN_DIR</code> directory (typically <code>/var/run/proftpd</code>).

<p>
Then, to see the call graph info, change to the directory where the
<code>bb.out</code> and <code>gmon.out</code> profiling files are, and
invoke the following command:
<pre>
  gprof /path/to/proftpd
</pre>
The <code>gprof</code> program has quite a few options for generating call
graphs and timing information; read the man page to find out more information.

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<hr><br>

Author: <i>$Author$</i><br>
Last Updated: <i>$Date$</i><br>

<br><hr>

<font size=2><b><i>
&copy; Copyright 2000-2003 TJ Saunders<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>
