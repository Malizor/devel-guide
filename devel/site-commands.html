<!-- $Id$ -->
<!-- $Source$ -->

<html>
<head>
<title>ProFTPD Developer's Guide: Module SITE Commands</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<img src="../images/proftpd.png" border=0>
<br><br>
<h3><b>ProFTPD Developer's Guide: Module <code>SITE</code> commands</b></h3>
<i><b>ProFTPD Version 1.2</b></i><br>
</center>
<hr><br>

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<p>
<b>Module <code>SITE</code> Commands</b><br>
Adding your own custom <code>SITE</code> is trivial.  You merely need
to define a <code>SITE</code> command handler in your module.

<p>
There should be two parts to a custom <code>SITE</code> command handler: one
part that handles the module-specific <code>SITE</code> command, and one
part to handle adding a description of that command in response to a
<code>SITE HELP</code> request from a client.

<p>
The example command handler below implements <code>SITE TIME</code>:
<pre>
MODRET site_time(cmd_rec *cmd) {

  <font color=green>/* Make sure it's a valid SITE TIME command, with no additional
   * parameters sent by the client.
   */</font>
  if (cmd->argc != 2)
    return DECLINED(cmd);

  <font color=green>/* This case does the work of returning the local time to the client
   */</font>
  if (!strcasecmp(cmd->argv[1], "TIME")) {
    char timestr[80] = {'\0'};
    time_t now = time(NULL);
    struct tm *tnow = NULL;

    <font color=green>/* If the user is required to be authenticated/logged in, do the
     * necessary check.  This may or may not be required, depending on
     * the SITE command being implemented.
     */</font>
    if (get_param_int(cmd->server->conf, "authenticated", FALSE) != TRUE) {
      send_response(R_530, "Please login with USER and PASS.");
      return ERROR(cmd);
    }

    <font color=green>/* Check for &lt;Limit&gt; restrictions */</font>
    if (!dir_check(cmd->tmp_pool, "SITE_TIME", "MISC", session.cwd, NULL)) {
      add_response_err(R_550, "%s: %s", cmd->arg, strerror(EPERM));
      return ERROR(cmd);
    }

    <font color=green>/* Log that the user requested the time.
     */</font>
    log_pri(LOG_INFO, "SITE TIME requested by user %s", session.user);

    <font color=green>/* Prepare the time string to be returned.
     */</font>
    if ((tnow = localtime(&now)) == NULL) {

      <font color=green>/* If, for some reason, an error occurs, use the 202 error code.
       * Other legal error codes for a SITE command include 500 (syntax
       * error, command not recognized), 501 (syntax error in parameters or
       * arguments), and 530 (not logged in).
       */</font>
      add_response(R_202, "Unable to provide the time right now");

      <font color=green>/* Of course, if something like localtime(3) fails, it should be
       * logged as well.
       */</font>
      log_pri(LOG_NOTICE, "notice: localtime() returned NULL?!?");

      return HANDLED(cmd);
    }

    <font color=green>/* Print the local time into the string buffer.
     */</font>
    strftime(timestr, sizeof(timestr), "%a %b %d %T %Z %Y", tnow); 
    timestr[sizeof(timestr) - 1] = '\0';

    <font color=green>/* The 200 response code is the normal value for such "generic" commands
     * as site-specific SITE commands.
     */</font>
    add_response(R_200, "The current time is: %s", timestr);

    <font color=green>/* If you want to add a multiline response, use the R_DUP macro, like
     * so:
     *
     *  add_response(R_DUP, ...);
     */</font>

    return HANDLED(cmd);
  }

  if (!strcasecmp(cmd->argv[1], "HELP")) {

    <font color=green>/* Add a description of SITE TIME to the output.  The response code
     * 214 is the appropriate value to use for "helpful" responses.
     */</font>
    add_response(R_214, "TIME");

    <font color=green>/* If this SITE command has needed a parameter (RFC959 only allows
     * one parameter to the SITE command, although not many servers seem to
     * strictly enforce this), this HELP line would have looked something like:
     *
     *  add_response(R_214, "TIME <param>");
     */</font>
  }

  <font color=green>/* This defaults to returning DECLINED in the case of a SITE HELP command.
   * This may seem wrong, but is actually correct: the case above adds
   * a response to the response chain for the current command, but does
   * not actually handle the command.  By returning DECLINED now, it
   * allows other modules to add their own SITE HELP responses to the chain
   * before the full chain is flushed back to the client once the command
   * is "officially" handled by mod_site.
   */</font>
  return DECLINED(cmd);
}
</pre>

The only remaining task is to register this command handler by adding
an appropriate entry to the module's <code>cmdtable</code>:
<pre>
  { CMD, C_SITE, G_NONE, site_time, FALSE, FALSE },
</pre>

Simple.  The key points to keep in mind are: use the correct response codes
as appropriate, provide support for the <code>SITE HELP</code> command
as well as for the custom functionality, require authentication as necessary,
and, as normal, perform as many checks on the input as necessary.  Do not
forget to document any custom <code>SITE</code> commands supported by your
module.

<p>
Note that the <code>requires_auth</code> field of the above
<code>cmdtable</code> entry (<i>i.e.</i> the first <code>FALSE</code>)
is <code>FALSE</code>, and that the example handler performs the same
authentication check (requiring that the user be authenticated before
using the command) as if <code>requires_auth</code> had been <code>TRUE</code>.
This is normal, and in general a good idea: let your <code>SITE</code>
handlers determine if and how to perform an authentication/authorization
check for themselves, rather than always relying on the core checking
ability.

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<hr><br>

Author: <i>$Author$</i><br>
Last Updated: <i>$Date$</i><br>

<br><hr>

<font size=2><b><i>
&copy; Copyright 2000-2002 TJ Saunders<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>
