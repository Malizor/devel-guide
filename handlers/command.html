<!-- $Id$ -->
<!-- $Source$ -->

<html>
<head>
<title>ProFTPD Developer's Guide: Command Handlers</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<img src="../images/proftpd.png" border=0>
<br><br>
<h3><b>ProFTPD Developer's Guide: Command Handlers</b></h3>
<i><b>ProFTPD Version 1.2</b></i><br>
</center>
<hr><br>

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<p>
<b>Command Handlers</b><br>
ProFTPD defines different phases, or <i>types</i>, to the handling of a
client-issued command.  There are currently five such command <i>types</i>:
<code>PRE_CMD</code>, <code>CMD</code>, <code>POST_CMD</code>,
<code>LOG_CMD</code>, and <code>LOG_CMD_ERR</code>.  When ProFTPD receives a
command from a client, it enters a cascading command delivery process:
<ol>
  <li>Call any <a href="#PreCommandHandler"><code>PRE_CMD</code></a> type
      handlers which match the special <code>*</code> command
      <a href="../src/include/ftp.h.html#C_ANY">wildcard</a>
  <li>Call any <a href="#PreCommandHandler"><code>PRE_CMD</code></a> type
      handlers which match the command.
  <li>Call any <a href="#CommandHandler"><code>CMD</code></a> type handlers
      which match the special <code>*</code> command
      <a href="../src/include/ftp.h.html#C_ANY">wildcard</a>
  <li>Call any <a href="#CommandHandler"><code>CMD</code></a> type handlers
      which match the command.
  <li>Call any <a href="#PostCommandHandler"><code>POST_CMD</code></a> type
      handlers which match the special <code>*</code> command
      <a href="../src/include/ftp.h.html#C_ANY">wildcard</a> if the
      <code>CMD</code> handler(s) succeeded.
  <li>Call any <a href="#PostCommandHandler"><code>POST_CMD</code></a> type
      handlers which match the command if the <code>CMD</code> handler(s)
      succeeded.
  <li>Call any <a href="#LogCommandHandler"><code>LOG_CMD</code></a> type
      handlers which match the special <code>*</code> command
      <a href="../src/include/ftp.h.html#C_ANY">wildcard</a> if the
      <code>CMD</code> handler(s) succeeded.
  <li>Call any <a href="#LogCommandHandler"><code>LOG_CMD</code></a> type
      handlers which match the command if the <code>CMD</code> handler(s)
      succeeded.
  <li>Call any <a href="#LogCommandErrorHandler"><code>LOG_CMD_ERR</code></a>
      type handlers which match the command if the <code>CMD</code>
      handler(s) failed.
</ol>

<p>
The return value of a particular command can allow or disallow further
dispatching.  This allows a higher priority module to <i>overload</i> a
command handler for a particular command, and allow or deny the command
as needed.

<p>
<a name="PreCommandHandler"></a>
<b>Pre-Command Handlers</b><br>
As a general rule of thumb,
<code><a href="../api/macros.html#PRE_CMD">PRE_CMD</a></code>-type command
handlers should check command syntax and basic applicability of the command,
check access restrictions, ensure the necessary resources are available,
<i>etc etc</i>.  When one of these handlers returns
<code><a href="../api/macros.html#DECLINED">DECLINED</a></code>, the next
<code>PRE_CMD</code>-type command handler will be called.  However, if it
returns <code><a href="../api/macros.html#ERROR">ERROR</a></code>, the
dispatching to all command handlers will stop completely, with the exception
of <code><a href="../api/macros.html#LOG_CMD_ERR">LOG_CMD_ERR</a></code>-type
command handlers, which will be called in the event of an
<code>ERROR</code>.

<p>
Below is an example of a
<code><a href="../api/macros.html#PRE_CMD">PRE_CMD</a></code>-type command
handler, which simply logs all received commands via
<code><a href="../api/functions.html#log_debug">log_debug()</a></code>.
It is careful to return
<code><a href="../api/macros.html#DECLINED">DECLINED</a></code>, otherwise
other
<code>PRE_CMD</code>-type command handlers would not get the request.  Note
that in order for this to work properly, this module would need to be loaded
<i>last</i>, or after any other modules which do not return
<code>DECLINED</code> for all their <code>PRE_CMD</code>-type command
handlers.  In practice, you should always return <code>DECLINED</code> unless
you plan on having your module actually handle the command, or deny it.

<p>
<b>Example <code>PRE_CMD</code> Handler</b><br>
<pre>
MODRET pre_cmd(cmd_rec *cmd) {

  log_debug(DEBUG0, "RECEIVED: command '%s', arguments '%s'",
     cmd->argv[0], cmd->arg);

  return DECLINED(cmd);
}
</pre>

<p>
<a name="CommandHandler"></a>
<b>Command Handlers</b><br>
<code><a href="../api/macros.html#CMD">CMD</a></code>-type command handlers
should do the actual <b><i>work</i></b>.  Much like
<code><a href="../api/macros.html#PRE_CMD">PRE_CMD</a></code>-type command
handlers, if
<code><a href="../api/macros.html#DECLINED">DECLINED</a></code> is returned
by a
<code>CMD</code>-type command handler, then the next registered
<code>CMD</code>-type command handler will be called with the same
<code>cmd_rec</code> pointer.  And, like
<code>PRE_CMD</code>-type command handlers, if an <code>ERROR</code> is
returned by a handler, the dispatching to other command handlers will halt;
only the
<code><a href="../api/macros.html#LOG_CMD_ERR">LOG_CMD_ERR</a></code>-type
command handlers will be called.

<p>
<a name="PostCommandHandler"></a>
<b>Post-Command Handlers</b><br>
<code>POST_CMD</code>-type command handlers generally handle any kind of
cleanup.  Should a command pass through the relevant
<code>PRE_CMD</code> and <code>CMD</code> command handlers without error,
then the registered <code>POST_CMD</code> handlers will be called.  If these
handlers return <code>ERROR</code>, their message, if any, will be sent to
<code>syslog</code>; not much else can be done, for the real work of the
command has already been accomplished by the <code>CMD</code> handlers.

<p>
<b>Example <code>POST_CMD</code> Handlers</b><br>
The global variable <i>session</i> contains a lot of important data after
a file/directory transfer of any kind, and is not cleared until
<code>mod_xfer</code> receives a <code>LOG_CMD</code>.  This is used
in these <code>POST_CMD</code> handlers, declared for the <code>LIST</code>,
<code>NLST</code>, <code>RETR</code>, and <code>STOR</code> FTP commands in
order to calculate the total data transfer for a session.
<pre>
static unsigned long total_received = 0, total_xferred = 0;

MODRET post_cmd_list(cmd_rec *cmd) {
  total_xferred += session.xfer.total_bytes;
  return DECLINED(cmd);
}

MODRET post_cmd_nlst(cmd_rec *cmd) {
  return post_cmd_list(cmd);
}

MODRET post_cmd_retr(cmd_rec *cmd) {
  return post_cmd_list(cmd);
}

MODRET post_cmd_stor(cmd_rec *cmd) {
  total_received += session.xfer.total_bytes;
  return DECLINED(cmd);
}
</pre>

<p>
<a name="LogCommandHandler"></a>
<b>Log Command Handlers</b><br>
<code>LOG_CMD</code> type handlers handle logging of successful commands.
These &quot;command&quot; handlers receive their commands only <i>after</i>
they have been processed, and only if those commands were <i>successful</i>.

<p>
<b>Example <code>LOG_CMD</code> Handler</b><br>
<pre>
MODRET log_cmd(cmd_rec *cmd) {

  log_debug(DEBUG0, "SUCCESSFUL: command '%s', arguments '%s'",
    cmd->argv[0], cmd->arg);

  return DECLINED(cmd);
}
</pre>

<p>
<a name="LogCommandErrorHandler"></a>
<b>Log Command Error Handlers</b><br>
And, as might be expected, <code>LOG_CMD_ERR</code> type handlers handle
logging of failed commands.  Handlers of type <code>LOG_CMD_ERR</code> will
be called in the event of an <code>ERROR</code> from either a
<code>PRE_CMD</code>  or a <code>CMD</code> handler.  At present, only
<code>modules/mod_log.c</code> declares a <code>LOG_CMD_ERR</code> type
handler, and it uses the same handler for both <code>LOG_CMD</code> and
<code>LOG_CMD_ERR</code> handling.  If for any reason you wanted to handle
logging or reporting of failed commands, either all or just specific commands,
this would be the type of handler to use.

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<hr><br>

Author: <i>$Author$</i><br>
Last Updated: <i>$Date$</i><br>

<br><hr>

<font size=2><b><i>
&copy; Copyright 2000-2002 TJ Saunders<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>
