<!-- $Id$ -->
<!-- $Source$ -->

<html>
<head>
<title>ProFTPD Developer's Guide: Internals - Configuration Contexts</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<img src="../images/proftpd.png">
<br><br>
<h3><b>ProFTPD Developer's Guide: Internals - Configuration Contexts</b></h3>
<i><b>ProFTPD Version 1.2.0</b></i><br>
</center>
<hr><br>

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<p>
<b>Configuration Contexts</b><br>
At present, ProFTPD has seven different configuration <i>contexts</i>:
&quot;main&quot; server, <code>&lt;Anonymous&gt;</code>,
<code>&lt;Directory&gt;</code>, <code>&lt;Global&gt;</code>,
<code>&lt;Limit&gt;</code>, <code>&lt;VirtualHost&gt;</code>, and
<code>.ftpaccess</code> files.  These contexts are checked for in
configuration handlers using the
<a href="../api/macros.html#CHECK_CONF"><code>CHECK_CONF</code></a> macro.

<p>
<b>&quot;Main&quot; server</b><br>
The &quot;main&quot; server context, listed as &quot;server config&quot; in
the configuration directive documentation, encompasses everything outside of the
other contexts (<i>i.e.</i> every configuration directive that is not explicitly
contained within another configuration context), and signalled by the macro
<a href="../api/macros.html#CONF_ROOT"><code>CONF_ROOT</code></a> in a
configuration directive handler.

<p>
<b><code>&lt;Anonymous&gt;</code></b><br>
The
<a href="http://www.proftpd.net/docs/configuration.html#Anonymous">
<code>&lt;Anonymous&gt;</code></a> section is used to set up the very common
configuration of an anonymous FTP server.  It does a <code>chroot()</code>
to the anonymous FTP directory by default, and turns off the requirement
for a valid password, requesting only a valid email address as the password.
Other system binaries or files need not be contained within the
<code>&lt;Anonymous&gt;</code> directory.

<p>
The
<a href="../api/macros.html#CONF_ANON"><code>CONF_ANON</code></a> macro is used
to define the <code>&lt;Anonymous&gt;</code> context.  Note that since
an <code>&lt;Anonymous&gt;</code> section is not considered a separate
server, but rather a &quot;subset&quot; of its containing server, any
configuration directives set for that server will be in effect for the
<code>&lt;Anonymous&gt;</code> as well, unless overridden by a directive
of the same name in the <code>&lt;Anonymous&gt;</code> context itself.

<p>
Context checks via
<a href="../api/macros.html#CHECK_CONF"><code>CHECK_CONF</code></a> in
configuration handlers should check for this <code>CONF_ANON</code> macro if
the configuration directive is to be allowed in the
<code>&lt;Anonymous&gt;</code> context.

<p>
<b><code>&lt;Directory&gt;</code></b><br>
The 
<a href="http://www.proftpd.net/docs/configuration.html#Directory">
<code>&lt;Directory&gt;</code></a> context is for configurations specific
to directories, of course.  This includes views of the contained files
based on the logged-in user's username or group membership or on the name
of the files (<i>e.g.</i> Unix-style &quot;hidden&quot; files), and on whether
the user has permission to see the files.  <code>.ftpaccess</code>
files occur within this context by definition; <code>&lt;Limit&gt;</code>
sections often appear in a <code>&lt;Directory&gt;</code> section as well.

<p>
Configuration handlers would check for the
<a href="../api/macros.html#CONF_DIR"><code>CONF_DIR</code></a> macro in
order to make sure that the configuration directive in question is occurring
in an allowed context.

<p>
<b><code>&lt;Global&gt;</code></b><br>
The description in the documentation for the
<a href="http://www.proftpd.net/docs/configuration.html#Global">
<code>&lt;Global&gt;</code></a> context is good.  Another point to know is
that if a directive is set in this context, and then the same directive is
used in the main or <code>&lt;VirtualHost&gt;</code> contexts with different
parameters, those parameters take precedence over the
<code>&lt;Global&gt;</code> parameters.  This allows you to configure things
for everyone equally, then tweak specific ervers individually, on a per-server
basis.

<p>
In configuration directive handlers and context checks, this context uses the
<a href="../api/macros.html#CONF_GLOBAL"><code>CONF_GLOBAL</code></a> macro.

<p>
<b><code>&lt;Limit&gt;</code></b><br>
The 
<a href="http://www.proftpd.net/docs/configuration.html#Limit">
<code>&lt;Limit&gt;</code></a> context is used to place limits on who
and how individual FTP commands, or groups of FTP commands, may be used.
<br>
<a href="../api/macros.html#CONF_LIMIT"><code>CONF_LIMIT</code></a>

<p>
<b><code>&lt;VirtualHost&gt;</code></b><br>
<a href="http://www.proftpd.net/docs/configuration.html#VirtualHost">
<code>&lt;VirtualHost&gt;</code></a><br>
<a href="../api/macros.html#CONF_VIRTUAL"><code>CONF_VIRTUAL</code></a>

<p>
<b><code>.ftpaccess</code> files</b><br>
These files are akin to Apache's <code>.htaccess</code> files, which
are parsed-on-the-fly configuration files -- with restricted scopes -- that
users can place in their own directories.  <i>Note</i> that
<code>.ftpaccess</code> are <i>similar</i> to Apache's <code>.htaccess</code>
files, they are <i>not the same</i>.  For example, ProFTPD's
<code>.ftpaccess</code> files do not support a &quot;require&quot; directive,
nor Apache's <code>AuthRealm</code> directive.  That particular area of
Apache configuration is targetted for restricting access to anonymous
connections; by its nature, ProFTPD handles anonymous connections as special
cases of the normal authenticated connections.

<p>
Configuration directive handlers that wish to allow their configuration
directive to be placed in this context do so via the
<a href="../api/macros.html#CONF_DYNDIR"><code>CONF_DYNDIR</code></a> macro.

<p>
<b>Configuration Flags</b><br>
The <code>config_rec</code> structure defines a <code>flags</code> member
that is used for signalling different configuration types.  At present, these
configuration types include:<br>
<ul>
  <li><a href="../api/macros.html#CF_DEFER"><code>CF_DEFER</code></a>
  <li><a href="../api/macros.html#CF_DYNAMIC"><code>CF_DYNAMIC</code></a>
  <li><a href="../api/macros.html#CF_MERGEDOWN"><code>CF_MERGEDOWN</code></a>
</ul>

<p>
The <code>CF_MERGEDOWN</code> flag is the most interesting of the flags, and
the one the developer is most likely to encounter.  It is used within a
configuration directive handler like so:
<pre>
  config_rec *c = NULL;

  c = add_config_param(...);
  <b>c->flags |= CF_MERGEDOWN;</b>
</pre>
This flag tells the context-processing functions that any lower configuration
contexts are to inherit this <code>config_rec</code> setting, unless the
lower context already has a <code>config_rec</code> of the same name.

<p>
The other two flags, <code>CF_DEFER</code> and <code>CF_DYNAMIC</code>, are
set automatically for <code>&lt;Anonymous&gt;</code> and <code>.ftpacces</code>
contexts, respectively.

<p>
<b>Creating your own contexts</b><br>

<a href="../api/functions.html#start_sub_config"><code>start_sub_config()</code></a>
<pre>
MODRET add_limit(cmd_rec *cmd)
{
  config_rec *c;
  int cargc;
  char **argv, **cargv;

  if(cmd->argc < 2)
    CONF_ERROR(cmd,"directive requires one or more FTP commands.");

  CHECK_CONF(cmd,CONF_ROOT|CONF_VIRTUAL|CONF_DIR|CONF_ANON|CONF_DYNDIR|CONF_GLOBAL);

  c = start_sub_config("Limit");
  c->config_type = CONF_LIMIT;
  cargc = cmd->argc - 1;
  cargv = cmd->argv + 1;

  c->argc = cmd->argc - 1;
  c->argv = pcalloc(c->pool, cmd->argc * sizeof(void *));
  argv = (char**)c->argv;

  while (cargc--)
    *argv++ = pstrdup(permanent_pool, *cargv++);

  *argv = NULL;

  return HANDLED(cmd);
}
</pre>

<a href="../api/functions.html#end_sub_config"><code>end_sub_config()</code></a>
<pre>
MODRET end_limit(cmd_rec *cmd)
{
  CHECK_ARGS(cmd, 0);
  CHECK_CONF(cmd, CONF_LIMIT);

  end_sub_config();
  return HANDLED(cmd);
}
</pre>

<a href="../api/functions.html#get_section_name"><code>get_section_name()</code></a><br>
<code>#define CONF_MYCTX</code><br>

<p>
The configuration subsystem is one of the areas targeted for change in the
1.3.x series, so expect this information to become obsolete in the future.

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<hr><br>

Author: <i>$Author$</i><br>
Last Updated: <i>$Date$</i><br>

<br><hr>

<font size=2><b><i>
&copy; Copyright 2000,2001 TJ Saunders<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>
