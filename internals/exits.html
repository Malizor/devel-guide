<!-- $Id$ -->
<!-- $Source$ -->

<html>
<head>
<title>ProFTPD Developer's Guide: Exit Handlers</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<img src="../images/proftpd.png" border=0>
<br><br>
<h3><b>ProFTPD Developer's Guide: Exit Handlers</b></h3>
<i><b>ProFTPD Version 1.2</b></i><br>
</center>
<hr><br>

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<p>
<b>Exit Handlers</b><br>
Sometimes, a module developer may wish to have a bit of code executed when
an FTP session ends, or when the daemon is being shut down.  ProFTPD's API
allows for this by providing the following callback registration function:
<pre>
  <a href="../src/src/support.c.html#pr_exit_register_handler">pr_exit_register_handler(void (*)(void))</a>
</pre>
All such registered callbacks will be executed, in their order of registration,
as part of the exit process for the session, or for the daemon.  Exit handlers
that are registered during part of a module's session initialization will
be executed when the session ends; exit handlers registered during module
initialization (<i>e.g.</i> when the daemon starts up) will be executed
both during a session exit (the <code>fork()</code>ed child process handling
the FTP session inherits its parent's memory space) and when the daemon shuts
down.  The callbacks executed during daemon shutdown will be run with root
privileges.

<p>
Exit handlers, as mentioned, are run as part of the exit process, which is
executed according to various conditions: an ACL denies access to the client,
a <code>MaxClients</code> or related limit is reached, the session times out,
the client issued a <code>QUIT</code> command, <i>etc</i>.  For whatever
reasons, the session process will decide to end the session, and will call
<a href="../src/src/main.c.html#end_login"><code>end_login()</code></a>.
The <code>end_login()</code> function calls <code>end_login_noexit()</code>,
whic: deletes the session entry from the scoreboard, calls all registered exit
handlers, cleans up the <code>wtmp</code> log, and closes any lingering
network connections. Then <code>end_login()</code> actually causes the process
to end, via the <code>_exit(2)</code> system call.

<p>
<b><i>Do not</i></b> re-register exit handlers; register them only <i>once</i>,
during module/session initialization.  Mulitple registration will cause the
callback to be executed multiple times, which is probably not what is
intended.  Also, take care when writing exit handlers.  The handler should
not <b>assume</b> anything about the state of pointers or variables: check
that pointers are not NULL before dereferencing them, that values are within
acceptable ranges before operating on them, etc.  Failure to do so will cause
your exit handler to segfault.

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<hr><br>

Author: <i>$Author$</i><br>
Last Updated: <i>$Date$</i><br>

<br><hr>

<font size=2><b><i>
&copy; Copyright 2000-2003 TJ Saunders<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>
