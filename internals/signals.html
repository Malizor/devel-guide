<!-- $Id$ -->
<!-- $Source$ -->

<html>
<head>
<title>ProFTPD Developer's Guide: Signals</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<img src="../images/proftpd.png" border=0>
<br><br>
<h3><b>ProFTPD Developer's Guide: Signals</b></h3>
<i><b>ProFTPD Version 1.2</b></i><br>
</center>
<hr><br>

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<p>
<b>Signal Processing</b><br>
As of version 1.2.6rc1, the way in which the daemon processes received
signals changed.  Signal handlers are notorious for introducing race
conditions; it is a consequence of running code asynchronously, as signal
handlers do.  The core code was significantly changed to avoid the actual
processing of signals so that such processing is run synchronously.  This
means that a signal handler merely sets a bit in a value, and exits swiftly,
when a signal is delivered to the process.  A call to a core signal processing
function,
<a href="../src/src/main.c.html#pr_signals_handle"><code>pr_signals_handle()</code></a>,
is done frequently in order to act, synchronously, on any received signals.

<p>
This also means that signals do not, for the most part, interrupt the core
code.  For example, a <code>while()</code> loop that can potentially loop
endlessly, and which does not call <code>pr_signals_handle()</code>, will
not be interrupted by most signals (<code>SIGKILL</code> being an obvious
exception).  Please keep this in mind when developing your module; feel
free to call <code>pr_signals_handle()</code> often, especially if a
system or library call returns <code>EINTR</code>, or when writing long
loops or recursive functions.  Here's an example that can be seen often
in the core code:
<pre>
  while (<i>syscall</i>() < 0) {
    if (errno == EINTR) {
      pr_signals_handle();
      continue;
    }

    break;
  }
</pre>
Alternatively, one could block signals before invoking the system call, and
unblock signals after the call, to prevent such interruptions.  Keep in mind
that any signals received while they are masked are silently ignored; they are
not queued by the kernel and redelivered to the process once they are unmasked.

<p>
<b>Signal Blocking and Masking</b><br>
<a href="../src/src/support.c.html#pr_signals_block"><code>pr_signals_block()</code></a><br>
<a href="../src/src/support.c.html#pr_signals_unblock"><code>pr_signals_unblock()</code></a><br>
These operate on the following signals: <code>TERM, CHLD, USR1, INT, QUIT, ALRM, IO, BUG, HUP</code>.

<p>
For blocking simply <code>SIGALRM</code>, use these two functions:<br>
<a href="../src/src/timers.c.html#pr_alarms_block"><code>pr_alarms_block()</code></a><br>
<a href="../src/src/timers.c.html#pr_alarms_unblock"><code>pr_alarms_unblock()</code></a><br>

<p>
The <code>SIGKILL</code> signal cannot be caught or ignored.

<p>
<b>Signal Handlers</b><br>
The core code implements handlers for the following signals:
<ul>
  <li><code>SIGABRT</code><br>
    Causes the daemon to abort

  <p>
  <li><code>SIGUSR1</code><br>
    Disconnects all sessions

  <p>
  <li><code>SIGUSR2</code><br>
    Prints memory pool debugging information to <code>stderr</code>

  <p>
  <li><code>SIGCHLD</code><br>
    Process an ended session

  <p>
  <li><code>SIGHUP</code><br>
    Rehash the configuration file; does not disconnect current sessions

  <p>
  <li><code>SIGTERM</code><br>
    Perform a normal shutdown of the daemon

  <p>
  <li><code>SIGXCPU</code><br>
    <code>RLimitCPU</code> reached; handled by <code>SIGTERM</code> handler

  <p>
  <li><code>SIGINT</code><br>
    Handled by <code>SIGTERM</code> handler

  <p>
  <li><code>SIGILL</code><br>
    Handled by <code>SIGTERM</code> handler

  <p>
  <li><code>SIGFPE</code><br>
    Handled by <code>SIGTERM</code> handler

  <p>
  <li><code>SIGSEGV</code><br>
    Handled by <code>SIGTERM</code> handler

  <p>
  <li><code>SIGURG</code><br>
     Ignored

  <p>
  <li><code>SIGSTKFLT</code><br>
    Handled by the <code>SIGTERM</code> handler if defined

  <p>
  <li><code>SIGBUS</code><br>
    Handled the <code>SIGTERM</code> handler if defined

  <p>
  <li><code>SIGIO</code><br>
    Ignored
</ul>

<p>
<center><a href="../toc.html">Table of Contents</a></center><br>

<hr><br>

Author: <i>$Author$</i><br>
Last Updated: <i>$Date$</i><br>

<br><hr>

<font size=2><b><i>
&copy; Copyright 2000-2003 TJ Saunders<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>
